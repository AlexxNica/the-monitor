# How to collect Varnish metrics

*This post is part 2 of a 3-part series on Varnish monitoring. [Part 1](https://www.datadoghq.com/blog/how-to-monitor-varnish/) explores the key metrics available in Varnish, and [Part 3](https://www.datadoghq.com/blog/monitor-varnish-using-datadog/) details how Datadog can help you to monitor Varnish.*

*このポストは、"Varnishの監視"3回シリーズのPart 2です。 Part 1は、[「Varnishの監視方法」」](https://www.datadoghq.com/blog/how-to-monitor-varnish/)で、Part 3は、[「Datadogを使ったVarnishの監視」](https://www.datadoghq.com/blog/monitor-varnish-using-datadog/)になります。*

## <span style="line-height: 1.5;">How to get the Varnish metrics you need</span>

> Varnish Cache ships with very useful and precise monitoring and logging tools. As explained in [the first post of this series](https://www.datadoghq.com/blog/how-to-monitor-varnish/), for monitoring purposes, the most useful of the available tools is `varnishstat` which gives you a detailed snapshot of Varnish’s current performance. It provides access to in-memory statistics such as cache hits and misses, resource consumption, threads created, and more.

Varnishキャッシュには、非常に便利で正確なモニタリングとロギングツールが同胞されています。このシリーズの最初のポスト[「Varnishの監視方法」](https://www.datadoghq.com/blog/how-to-monitor-varnish/)で紹介したように、監視のために最も便利なツールは`varnishstat`です。`varnishstat`は、Varnishの現時点でのパフォーマンスの詳細な情報を提供してくれます。更に、キャッシュのヒットやミス、リソース消費量、作成されたスレッドなど、メモリー内にある統計情報にもアクセスも提供しています。

### varnishstat

> If you run `varnishstat` from the command line you will see a continuously updating list of all available Varnish metrics. If you add the `-1` flag, varnishstat will exit after printing the list one time. Example output below:

コマンドラインから`varnishstat`を実行すると、継続的に更新されていくVarnishの全てのメトリクを見ることができます。このコマンドに、表示回数オプションの`-1`を付けて実行すれば、`varnishstat`は、リストを1度表示し、終了します。

以下は出力結果の例です:

```
$ varnishstat

   MAIN.uptime                  Child process uptime
   MAIN.sess_conn               Sessions accepted
   MAIN.sess_drop               Sessions dropped
   MAIN.sess_fail               Session accept failures
   MAIN.sess_pipe_overflow      Session pipe overflow
   MAIN.client_req              Good client requests received
   MAIN.cache_hit               Cache hits
   MAIN.cache_hitpass           Cache hits for pass
   MAIN.cache_miss              Cache misses
   MAIN.backend_conn            Backend conn. success
   MAIN.backend_unhealthy       Backend conn. not attempted
   MAIN.backend_busy            Backend conn. too many
   MAIN.backend_fail            Backend conn. failures
   MAIN.backend_reuse           Backend conn. reuses
   MAIN.backend_toolate         Backend conn. was closed
   MAIN.backend_recycle         Backend conn. recycles
   MAIN.backend_retry           Backend conn. retry
   MAIN.pools                   Number of thread pools
   MAIN.threads                 Total number of threads
   MAIN.threads_limited         Threads hit max
   MAIN.threads_created         Threads created
   MAIN.threads_destroyed       Threads destroyed
   MAIN.threads_failed          Thread creation failed
   MAIN.thread_queue_len        Length of session queue
```

> To list specific values, pass them with the `-f` flag: e.g. `varnishstat -f field1,field2,field3`, followed by `-1` if needed.

特定の値を表示したい場合は、`-f`フラグを追記します: 例えば、`varnishstat -f field1,field2,field3`を追記し値を指定し、`-1`を追加し表示回数を指定します。

> For example: `varnishstat -f MAIN.threads` will display a continuously updating count of threads currently being used:

例: `varnishstat -f MAIN.threads`は、現在使用しているスレッドの値を継続的に更新しながら表示します。

 [![varnishstat output](https://don08600y3gfm.cloudfront.net/ps3b/blog/images/2015-07-varnish/2-01.png)](https://don08600y3gfm.cloudfront.net/ps3b/blog/images/2015-07-varnish/2-01.png)

> Varnishstat is useful as a standalone tool if you need to spot-check the health of your cache. However, if Varnish is an important part of your software service, you will almost certainly want to graph its performance over time, correlate it with other metrics from across your infrastructure, and be alerted about any problems that may arise. To do this you will probably want to integrate the metrics that Varnishstat is reporting with a dedicated monitoring service.

Varnishstatは、キャッシュの状態をスポット的にチェックするのはは非常に優れた単体ツールです。しかし、Varnishがソフトウェアサービスの重要な構成要素である場合は、パフォーマンスヒストリーを表示したグラフ、インフラ上の他のメトリクスと連携した分析、障害が発生した時のアラートのような機能が必要と感じるようになるでしょう。このようなニーズを満たすためにあなたは、Varnishstatが収集しているメトリクスを専用の監視サービスへ送信することになるでしょう。

### varnishlog

> If you need to debug your system or tune configuration, `varnishlog` can be a useful tool, as it provides detailed information about each individual request.

Varnishのシステムのデバッグや設定のチューニングをする必要がある場合は、`varnishlog`は、便利なツールになります。`varnishlog`は、個々のリクエストに関する詳細な情報を提供してくれます。

> Here is an edited example of `varnishlog` output generated by a single request—a full example would be several times longer:

下記に示す内容は、`varnishlog`の出力の一部です。正式な出力は、下記に示したものの数倍の長さになります:

```
$ varnishlog

   3727 RxRequest    c GET
   3727 RxProtocol   c HTTP/1.1
   3727 RxHeader     c Content-Type: application/x-www-form-urlencoded;
   3727 RxHeader     c Accept-Encoding: gzip,deflate,sdch
   3727 RxHeader     c Accept-Language: en-US,en;q=0.8
   3727 VCL_return   c hit
   3727 ObjProtocol  c HTTP/1.1
   3727 TxProtocol   c HTTP/1.1
   3727 TxStatus     c 200
   3727 Length       c 316
…
```

> The 4 columns represent:
> 1.  Request ID
> 2.  Data type (if the type starts with “Rx” that means Varnish is receiving data, and “Tx” means Varnish is sending data)
> 3.  Whether this entry records communication between Varnish and the client: “c”, or backend: “b” (see [Part 1](https://www.datadoghq.com/blog/how-to-monitor-varnish/))
> 4.  The data, or details about this entry

出力内の4つ列は、内容は以下のようになります:

1. リクエストID
2. データタイプ (“Rx”の文字列で始まる項目は、Varnishがデーターを受信。“Tx”の文字列で始まる項目は、Varnishがデーターを送信。)
3. このメトリクスが、Varnishとクライアント間通信のものは、"c"。Varnishとバックエンド間通信のものは、"b"。（詳細は、[「Varnishの監視方法」]（https://www.datadoghq.com/blog/how-to-monitor-varnish/ ）を参照してください）
4. データー、又はその詳細

### varnishlog’s children

> You can display a subset of `varnishlog`’s information via three specialized tools built on top of varnishlog:

> - `varnishtop` presents a continuously updating list of the most commonly occurring log entries. Using filters, you can display the topmost requested documents, most common clients, user agents, or any other information which is recorded in the log.
> - `varnishhist` presents a continuously updating histogram showing the distribution of the last N requests bucketed by total time between request and response. The value of N and the vertical scale are displayed in the top left corner.
> - `varnishsizes` is very similar to varnishhist, except it shows the size of the objects requested rather than the processing time.

`varnishlog`が提供している情報のサブセットを、varnishlogの上に構築された、次のような三つの特殊ツールで表示することができます。

- `varnishtop`は、最も一般的なログエントリのリストを継続的に表示します。フィルターを使用し、最もリクエストされたドキュメンント、最も一般的なクライアント、ユーザエージェント、またはログに記録されている他の情報を表示することができます。
- `varnishhist`は、直近N個のリクエストの受信から応答までの時間のヒストグラムを継続的に表示します。Nの値と縦軸の単位は、左上隅に表示されます。
- `varnishsizes`は、varnishhistに非常に似ています。ただし、`varnishsizes`は、処理時間ではなく、リクエストされたオブジェクトの大きさを表示します。

## <span style="line-height: 1.5;">Conclusion</span>

Which metrics you monitor will depend on your use case, the tools available to you, and whether the insight provided by a given metric justifies the overhead of monitoring it.


何を監視するかは、持っているツールと監視可能なメトリクスの種類に依存します。そして、それぞれのメトリクスが提供する見識の価値こそがそのメトリクスを監視するための労力を正当化してくれるでしょう。

At Datadog, we have built an integration with Varnish so that you can begin collecting and monitoring its metrics with a minimum of setup. Learn how Datadog can help you to monitor Varnish in the [next and final part of this series of articles](https://www.datadoghq.com/blog/monitor-varnish-using-datadog/).

Datadogでは、Varnishに向けてIntegrationを提供しています。このIntegrationを採用することで、最小限の設定でメトリクスを収集し監視できるようになります。このシリーズに含まれる[「Datadogを使ったVarnishの監視」](https://www.datadoghq.com/blog/monitor-varnish-using-datadog/)では、Datadogを使ったVarnishの監視方法を解説しています。

------------------------------------------------------------------------

> *Source Markdown for this post is available [on GitHub](https://github.com/DataDog/the-monitor/blob/master/varnish/how_to_collect_varnish_metrics.md). Questions, corrections, additions, etc.? Please [let us know](https://github.com/DataDog/the-monitor/issues).*

*このポストのMarkdownソースは、[GitHub](https://github.com/DataDog/the-monitor/blob/master/varnish/how_to_collect_varnish_metrics.md)で閲覧することができます。質問、訂正、追加、などがありましたら、[GitHubのissueページ](https://github.com/DataDog/the-monitor/issues)を使って連絡を頂けると幸いです。*
